---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

includes:
  backend: 
    taskfile: ./.taskfiles/Backend/Taskfile.yaml
    aliases:
      - be
  frontend:
    taskfile: ./.taskfiles/Frontend/Taskfile.yaml
    aliases:
      - fe
tasks:
  default: task -l
  dev:
    desc: "Run development servers"
    cmd: mprocs
  db:prepare:
    desc: "Prepare SQLx for offline"
    cmd: cargo sqlx prepare --workspace -- --tests
  db:migrate:
    desc: "Run every migration"
    cmds:
      - task: backend:migrate
  db:reset:
    desc: "Reset database"
    dir: "backend"
    cmd: cargo sqlx database reset
  db:check:
    desc: "Check if SQLx prepared files are generated"
    cmd: cargo sqlx prepare --workspace --check -- --tests
  test:
    desc: "Testing the application"
    cmd: "cargo nextest run"
    env:
      SQLX_OFFLINE: true
  test:coverage:
    desc: "Test the application (with coverage)"
    cmd: "cargo llvm-cov nextest"
    env:
      SQLX_OFFLINE: true
  test:coverage:ci:
    desc: "Test the application (with coverage; export to LCOV for CodeCov)"
    cmd: "cargo llvm-cov nextest --lcov --output-path lcov.info"
    env:
      SQLX_OFFLINE: true
  unused:
    desc: "Check for unused dependencies"
    cmds:
      - task: backend:unused
      - task: frontend:unused
  install:
    desc: "Install dependencies"
    cmds:
      - task: backend:install
      - task: frontend:install
    aliases:
      - i
      - deps
  lint:
    desc: "Lint everything"
    cmds:
      - task: backend:lint
      - task: frontend:lint
  lint:fix:
    desc: "Fix linting errors"
    cmds:
      - task: backend:lint:fix
      - task: frontend:lint:fix
  proxy:
    desc: "Run proxy for Tempo"
    cmd: "caddy run"
